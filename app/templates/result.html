{% extends "base.html" %}

{% block title %}結果 - 順番決めるくん 2{% endblock %}

{% block content %}
<div class="url-share-container" style="display: flex; justify-content: center; margin-bottom: 2rem;">
    <button onclick="copyUrl()" class="btn" style="padding: 8px 16px; display: flex; align-items: center; gap: 5px;">
        <span>このページのURLをコピー</span>
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
            <path
                d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
        </svg>
    </button>
</div>

<h1>決定された順番</h1>

<ul class="result-list">
    {% for name in names %}
    <li class="result-item">
        <div style="display: flex; align-items: center;">
            <span class="rank">{{ loop.index }}</span>
            <span class="name">{{ name }}</span>
        </div>

        {% if enable_likes %}
        <div style="display: flex; align-items: center; gap: 5px;">
            <button class="like-btn" onclick="sendLike('{{ page_id }}', '{{ name }}', this)" title="いいね！">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M14.6,2.5c-1.3,0-2.5,0.7-3.2,1.8l-1.4,2.2l-1.4-2.2c-0.7-1.1-1.9-1.8-3.2-1.8C2.5,2.5,0,5,0,8.1c0,3.7,3.3,6.8,8.2,11.3l1.8,1.6l1.8-1.6C16.7,14.9,20,11.8,20,8.1C20,5,17.5,2.5,14.6,2.5z" />
                </svg>
            </button>
            <span class="like-count" style="font-size: 1.2rem; min-width: 20px;">0</span>
        </div>
        {% endif %}
    </li>
    {% endfor %}
</ul>

<div style="margin-top: 2rem;">
    <a href="/" class="btn" style="background-color: var(--border-color); color: var(--text-color);">もう一度やる</a>
</div>
{% endblock %}

{% block scripts %}
{% if enable_likes %}
<script>
    async function sendLike(pageId, name, btn) {
        // Optimistic UI update
        btn.classList.add('liked');

        // Increment local counter
        const countSpan = btn.parentElement.querySelector('.like-count');
        if (countSpan) {
            let count = parseInt(countSpan.textContent) || 0;
            countSpan.textContent = count + 1;
        }

        // Add a little pop effect reset after animation
        setTimeout(() => {
            btn.classList.remove('liked');
        }, 300);

        try {
            const response = await fetch('/api/like', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    page_id: pageId,
                    id: name
                })
            });

            const data = await response.json();
            console.log('Like sent:', data);

            if (data.status === 'ignored') {
                console.warn('Like ignored:', data.reason);
            }
        } catch (error) {
            console.error('Error sending like:', error);
        }
    }
</script>
{% endif %}
<script>
    function copyUrl() {
        const url = window.location.href;

        // Try the modern Clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(() => {
                showCopyFeedback();
            }).catch(err => {
                console.error('Clipboard API failed:', err);
                fallbackCopyTextToClipboard(url);
            });
        } else {
            fallbackCopyTextToClipboard(url);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;

        // Avoid scrolling to bottom
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopyFeedback();
            } else {
                console.error('Fallback: Copying text command was unsuccessful');
                alert('コピーに失敗しました。URLを手動でコピーしてください。');
            }
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
            alert('コピーに失敗しました。');
        }

        document.body.removeChild(textArea);
    }

    function showCopyFeedback() {
        // Visual feedback
        const btn = document.querySelector('.url-share-container button');
        const originalText = btn.innerHTML;

        btn.innerHTML = `
            <span>コピーしました!</span>
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
        `;
        btn.style.backgroundColor = '#4CAF50';
        btn.style.color = 'white';

        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.backgroundColor = '';
            btn.style.color = '';
        }, 2000);
    }
</script>
{% endblock %}